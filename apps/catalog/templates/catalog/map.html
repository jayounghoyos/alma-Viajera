{% extends "base.html" %}
{% comment %} Juan Andrés Young Hoyos {% endcomment %}
{% load static i18n l10n %}

{% block title %}{% trans "Mapa · Alma Viajera" %}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/map.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block body_class %}map-page{% endblock %}

{% block content %}
<div class="container-fluid p-0">
  <!-- Header del mapa -->
  <div class="map-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="map-title">{% trans "Selecciona tu destino" %}</h1>
          <p class="map-subtitle">
            {% trans "Explora los mejores lugares, tours y experiencias de cada país" %}
          </p>
        </div>
        <div class="col-md-4 text-end">
          <a href="{% url 'core:home' %}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left"></i> {% trans "Volver al inicio" %}
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor del mapa -->
  <div class="map-container">
    <div id="map"></div>
    
    <!-- Panel de países -->
    <div class="countries-panel">
      <h3>{% trans "Países disponibles" %}</h3>
      <div class="countries-carousel">
        <button class="carousel-btn prev" type="button" aria-label="{% trans 'País anterior' %}">
          <i class="bi bi-chevron-left"></i>
        </button>
        <div class="countries-list" id="countriesList">
          {% for pais in paises %}
          <div class="country-item" data-country="{{ pais.codigo }}" data-lat="{{ pais.lat|unlocalize }}" data-lng="{{ pais.lng|unlocalize }}"
               role="button" tabindex="0" aria-label="{% blocktrans trimmed with country=pais.nombre %}Enfocar {{ country }} en el mapa{% endblocktrans %}">
            <div class="country-flag">
              <i class="bi bi-geo-alt-fill"></i>
            </div>
            <div class="country-info">
              <h4>{{ pais.nombre }}</h4>
              <p>{% trans "Explorar destinos" %}</p>
            </div>
            <div class="country-arrow" data-country="{{ pais.codigo }}" role="button" tabindex="0"
                 aria-label="{% blocktrans trimmed with country=pais.nombre %}Ir a {{ country }}{% endblocktrans %}">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
          {% endfor %}
        </div>
        <button class="carousel-btn next" type="button" aria-label="{% trans 'Siguiente país' %}">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar el mapa
  const map = L.map('map').setView([0, 0], 2);
  
  // Agregar capa de tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);
  
  // Array y diccionario para almacenar los marcadores
  const markers = [];
  const markersByCode = {};
  
  // Agregar marcadores para cada país
  {% for pais in paises %}
  const marker{{ forloop.counter }} = L.marker([{{ pais.lat|unlocalize }}, {{ pais.lng|unlocalize }}])
    .addTo(map)
    .bindPopup(`
      <div class="map-popup">
        <h4>{{ pais.nombre }}</h4>
        <p>{% trans "Haz clic para explorar este país" %}</p>
        <button class="btn btn-primary btn-sm explore-btn" data-country="{{ pais.codigo }}">
          {% trans "Explorar" %} {{ pais.nombre }}
        </button>
      </div>
    `);
  
  markers.push(marker{{ forloop.counter }});
  markersByCode["{{ pais.codigo }}"] = marker{{ forloop.counter }};
  {% endfor %}
  
  // Ajustar la vista para mostrar todos los marcadores
  if (markers.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
  
  // Carrusel de países
  const countriesList = document.getElementById('countriesList');
  const prevBtn = document.querySelector('.carousel-btn.prev');
  const nextBtn = document.querySelector('.carousel-btn.next');
  const desktopQuery = window.matchMedia('(min-width: 992px)');
  const HORIZONTAL_STEP = 260;
  const VERTICAL_STEP = 220;

  function isVerticalLayout() {
    return desktopQuery.matches;
  }

  function updateCarouselButtons() {
    if (!countriesList) return;

    if (isVerticalLayout()) {
      const maxScrollTop = countriesList.scrollHeight - countriesList.clientHeight;
      if (prevBtn) {
        prevBtn.disabled = countriesList.scrollTop <= 0;
      }
      if (nextBtn) {
        nextBtn.disabled = countriesList.scrollTop >= (maxScrollTop - 4);
      }
    } else {
      const maxScrollLeft = countriesList.scrollWidth - countriesList.clientWidth;
      if (prevBtn) {
        prevBtn.disabled = countriesList.scrollLeft <= 0;
      }
      if (nextBtn) {
        nextBtn.disabled = countriesList.scrollLeft >= (maxScrollLeft - 4);
      }
    }
  }

  function scrollCountries(direction) {
    if (!countriesList) return;
    const behavior = { behavior: 'smooth' };

    if (isVerticalLayout()) {
      countriesList.scrollBy({ ...behavior, top: direction * VERTICAL_STEP });
    } else {
      countriesList.scrollBy({ ...behavior, left: direction * HORIZONTAL_STEP });
    }
  }

  if (countriesList && prevBtn && nextBtn) {
    prevBtn.addEventListener('click', () => scrollCountries(-1));
    nextBtn.addEventListener('click', () => scrollCountries(1));

    countriesList.addEventListener('scroll', updateCarouselButtons, { passive: true });
    window.addEventListener('resize', updateCarouselButtons);

    if (typeof desktopQuery.addEventListener === 'function') {
      desktopQuery.addEventListener('change', updateCarouselButtons);
    } else if (typeof desktopQuery.addListener === 'function') {
      desktopQuery.addListener(updateCarouselButtons);
    }

    updateCarouselButtons();
  }
  
  // Función para redirigir al explorador
  function exploreCountry(countryCode) {
    window.location.href = `{% url 'catalog:explorar' 'PLACEHOLDER' 'lugar' %}`.replace('PLACEHOLDER', countryCode);
  }

  function focusCountry(countryCode, lat, lng, options = {}) {
    const { openPopup = true, zoomLevel = 6 } = options;
    if (!lat || !lng) return;
    const targetLat = parseFloat(lat);
    const targetLng = parseFloat(lng);
    if (Number.isNaN(targetLat) || Number.isNaN(targetLng)) return;

    map.setView([targetLat, targetLng], zoomLevel);
    const marker = markersByCode[countryCode];
    if (marker && openPopup) {
      marker.openPopup();
    }
  }
  
  // Event listeners para los elementos del país
  document.querySelectorAll('.country-item').forEach(item => {
    item.addEventListener('click', function() {
      focusCountry(this.dataset.country, this.dataset.lat, this.dataset.lng);
    });
    
    // Efecto hover para escritorio
    item.addEventListener('mouseenter', function() {
      focusCountry(this.dataset.country, this.dataset.lat, this.dataset.lng, { openPopup: false });
    });

    item.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        focusCountry(this.dataset.country, this.dataset.lat, this.dataset.lng);
      }
    });
  });

  document.querySelectorAll('.country-arrow').forEach(arrow => {
    arrow.addEventListener('click', function(event) {
      event.stopPropagation();
      exploreCountry(this.dataset.country);
    });

    arrow.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        event.stopPropagation();
        exploreCountry(this.dataset.country);
      }
    });
  });
  
  // Event listeners para los botones de explorar en los popups
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('explore-btn')) {
      const countryCode = e.target.dataset.country;
      exploreCountry(countryCode);
    }
  });
});
</script>
{% endblock %}
